\ProvidesPackage{lyluatex}

% Dependencies
\RequirePackage{luatexbase}
\RequirePackage{luaotfload}
\RequirePackage{kvoptions}
\RequirePackage{graphicx}
\RequirePackage{keycommand}
\RequirePackage{environ}
\RequirePackage{currfile}
\RequirePackage{pdfpages}

\RequirePackage{metalogo}
\newcommand{\lyluatex}{\textit{ly}\LuaTeX}

% Options
\catcode`-=11
\directlua{
  dofile(kpse.find_file("lyluatex.lua"))
  declare_package_options( {
    ['program'] = 'lilypond',
    ['tmpdir'] = 'tmp_ly',
    ['showfailed'] = 'true',
    ['staffsize'] = '0',
    ['line-width'] = 'default',
    ['includepaths'] = ''
  } )
  set_default_options()
  reset_local_options()
}
\catcode`-=12

\newcommand{\pt}{pt}
\newcommand{\mm}{mm}
\newcommand{\cm}{cm}

% Commands to change options during the document
\newcommand{\lilypondCmd}[1]{%
    \directlua{set_option('program', '#1')}
}
% Staff size is calculated in relation to text size if set to 0 (default)
\newcommand{\lilypondStaffsize}[1]{%
    \directlua{set_option('staffsize', '#1')}
}
% Line width is calculated if set to 'default'
\def\defaultwidth{default}
\catcode`-=11
\def\calclinewidth{
  \ifx\lyluatex@line-width\defaultwidth
  \directlua{
    set_option('line-width', '\the\linewidth')
  }
  \else
  \directlua{
    set_option('line-width',\lyluatex@line-width)
  }
  \fi
}
\newcommand{\lilypondLinewidth}[1]{%
  \edef\lyluatex@line-width{#1}
  \directlua{set_option('line-width', #1)}
}
\catcode`-=12
% Include paths for lilypond documents
\newcommand{\lilypondIncludePaths}[1]{%
    \directlua{set_option('includepaths', '#1')}
}

% Main commands
% Inclusion of a .ly file
\newkeycommand*\includely[%
    fullpage=false%
    ,staffsize%
    ,line-width%
    ,program%
    ,includepaths%
    ][other-options][1]{%
\calclinewidth
\directlua{
    set_local_options({
      ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
      ['line-width'] = '\luatexluaescapestring{\commandkey{line-width}}',
      ['includepaths'] = '\luatexluaescapestring{\commandkey{includepaths}}',
      ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
    lilypond_file(
        "\luatexluaescapestring{#1}",
        "\luatexluaescapestring{\currfiledir}",
        \commandkey{fullpage}
    )%
}%
\directlua{reset_local_options()}%
}

% Base environment to include a LilyPond fragment integrated into
% the document.
\NewEnviron{compilerly}{%
\calclinewidth
\directlua{%
    lilypond_fragment(
        "\luatexluaescapestring{\unexpanded\expandafter{\BODY}}"
    )%
}%
}

% Parametrized command and environment for included LilyPond fragment
\newkeycommand{\lily}[%
    staffsize%
    ,line-width%
    ,program%
    ,includepaths%
    ][other-options][1]{%
\directlua{
    set_local_options({
      ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
      ['line-width'] = '\luatexluaescapestring{\commandkey{line-width}}',
      ['includepaths'] = '\luatexluaescapestring{\commandkey{includepaths}}',
      ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
}
\begin{compilerly}%
{#1}
\end{compilerly}%
\directlua{reset_local_options()}%
}

\newkeyenvironment{ly}[%
    staffsize%
    ,line-width%
    ,program%
    ,includepaths%
    ][other-options]{%
\directlua{
    set_local_options({
      ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
      ['line-width'] = '\luatexluaescapestring{\commandkey{line-width}}',
      ['includepaths'] = '\luatexluaescapestring{\commandkey{includepaths}}',
      ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
}
\compilerly%
}{%
\endcompilerly%
\directlua{reset_local_options()}%
}

% Commands for compatibility with lilypond-book
\let\lilypondfile\includely
\protected\def\lilypond{\def\reserved@a{lilypond}%
  \ifx\reserved@a\@currenvir \expandafter \ly
  \else \expandafter\lily \fi}
\let\endlilypond\endly
