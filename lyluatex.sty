\ProvidesPackage{lyluatex}

% Dépendances
\RequirePackage{graphicx}
\RequirePackage{keycommand}
\RequirePackage{fancyvrb}
\RequirePackage{luacode}
% Script lua
\directlua{dofile(kpse.find_file("lyluatex.lua"))}

% Une tricherie un peu sale pour récupérer la largeur de ligne
\let\bs\textbackslash
{\catcode`p=12 \catcode`t=12 \gdef\un#1pt{#1}}
\newcommand*{\largeur}{\expandafter\un\the\linewidth}
% Taille par défaut des partitions
\newcounter{staffsize}
\setcounter{staffsize}{17}
% La commande principale
\newkeycommand*\includely[staffsize=\arabic{staffsize}][1]{%
    \directlua{InclureLy(\luastring{#1},\luastring{\largeur},\luastring{\commandkey{staffsize}})}
}
\let\lilypondfile\includely

\newwrite\lyfile
\newcounter{tmply}
\newenvironment{ly}{%
\stepcounter{tmply}
\def\lyfile{tmp_ly/\alph{tmply}.ly}
\VerbatimOut{\lyfile}%
}{%
\endVerbatimOut%
\includely{\lyfile}%
}

\newenvironment{lilypond}{%
\stepcounter{tmply}
\def\lyfile{tmp_ly/\alph{tmply}.ly}
\VerbatimOut{\lyfile}%
}{%
\endVerbatimOut%
\includely{\lyfile}%
}
