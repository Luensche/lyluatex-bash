\ProvidesPackage{lyluatex}

% Dépendances
\RequirePackage{graphicx}
\RequirePackage{keycommand}
\RequirePackage{environ}
\def\luastring#1{\luatexluaescapestring{#1}}
% Script lua
\directlua{dofile(kpse.find_file("lyluatex.lua"))}

% Une tricherie un peu sale pour récupérer la largeur de ligne
\let\bs\textbackslash
{\catcode`p=12 \catcode`t=12 \gdef\un#1pt{#1}}
\newcommand*{\largeur}{\expandafter\un\the\linewidth}
% Taille des partitions
\newcounter{staffsize}\setcounter{staffsize}{17}
\newcounter{localstaffsize}


% Commandes principales
% Inclusion d'un fichier ly
\newkeycommand*\includely[staffsize=\arabic{staffsize}][autres][1]{%
\directlua{%
    inclure_ly(
        "\luastring{#1}",
        \luastring{\largeur},
        \luastring{\commandkey{staffsize}}
    )%
}%
}

% Inclusion d'un fragment intégré au document (environnement de base)
\NewEnviron{compilerly}{%
\directlua{%
    direct_ly(
        "\luatexluaescapestring{\unexpanded\expandafter{\BODY}}",
        \luastring{\largeur},
        \luastring{\arabic{localstaffsize}}
    )%
}%
}

% Commande et environnement avec paramètres
\newkeycommand{\lily}[staffsize=\arabic{staffsize}][autres][1]{%
\setcounter{localstaffsize}{\commandkey{staffsize}}%
\begin{compilerly}%
#1
\end{compilerly}%
}

\newkeyenvironment{ly}[staffsize=\arabic{staffsize}][autres]{%
\setcounter{localstaffsize}{\commandkey{staffsize}}%
\compilerly%
}{
\endcompilerly%
}

% Commandes pour la compatibilité avec lilypond-book
\let\lilypondfile\includely
\let\lilypond\ly
\let\endlilypond\endly
