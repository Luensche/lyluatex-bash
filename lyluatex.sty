\ProvidesPackage{lyluatex}

% Dependencies
\RequirePackage{luatexbase}
\RequirePackage{luaotfload}
\RequirePackage{kvoptions}
\RequirePackage{graphicx}
\RequirePackage{keycommand}
\RequirePackage{environ}
\RequirePackage{currfile}
\RequirePackage{pdfpages}

\RequirePackage{metalogo}
\newcommand{\lyluatex}{\textit{ly}\LuaTeX}

% Options
\DeclareStringOption[lilypond]{program}[lilypond]
\DeclareStringOption[default]{line-width}[lilypond]
\DeclareStringOption[tmp_ly]{tmpdir}[lilypond]
\DeclareStringOption[true]{showfailed}
\DeclareStringOption[0]{staffsize}[0]
\newcommand{\pt}{pt}
\newcommand{\mm}{mm}
\newcommand{\cm}{cm}
\ProcessKeyvalOptions*
% Lua Script
\directlua{
OPTIONS = {
    ['lilypondcmd'] = '\luatexluaescapestring{\lyluatex@program}',
    ['tmpdir'] = '\luatexluaescapestring{\lyluatex@tmpdir}',
    ['showfailed'] = '\luatexluaescapestring{\lyluatex@showfailed}',
    ['staffsize'] = '\luatexluaescapestring{\lyluatex@staffsize}'
}

dofile(kpse.find_file("lyluatex.lua"))
reset_local_options()}
\directlua{}

% Commands to change options during the document
\newcommand{\lilypondCmd}[1]{%
    \directlua{OPTIONS.lilypondcmd = [[#1]]}
}
% Staff size is calculated in relation to text size if set to 0 (default)
\newcommand{\lilypondStaffsize}[1]{%
    \directlua{
        ss = tostring([[#1]])
        if ss == '0' then ss = '' end
        OPTIONS.staffsize = ss
    }
}

\def\defaultwidth{default}
\catcode`-=11
\ifx\lyluatex@line-width\defaultwidth
\catcode`-=12
% A somewhat dirty trick to determine the line width
\let\bs\textbackslash
{\catcode`p=12 \catcode`t=12 \gdef\un#1pt{#1}}
\newcommand*{\lilywidth}{\the\linewidth}
\else
\catcode`-=11
\let\lilywidth\lyluatex@line-width
\catcode`-=12
\fi
\let\localwidth\lilywidth


% Main commands
% Inclusion of a .ly file
\newkeycommand*\includely[%
    fullpage=false%
    ,staffsize=\directlua{ get_option('staffsize') }%
    ,line-width=\lilywidth%
    ,program=\directlua{ get_option('lilypondcmd') }%
    ][other-options][1]{%
\directlua{
    set_local_options({
        ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
        ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
    lilypond_file(
        "\luatexluaescapestring{#1}",
        "\luatexluaescapestring{\currfiledir}",
        '\commandkey{line-width}',
        \commandkey{fullpage}
    )%
}%
\directlua{reset_local_options()}%
}

% Base environment to include a LilyPond fragment integrated into
% the document.
\NewEnviron{compilerly}{%
\directlua{%
    lilypond_fragment(
        "\luatexluaescapestring{\unexpanded\expandafter{\BODY}}",
        '\localwidth',
        \luatexluaescapestring{\localstaffsize}
    )%
}%
}

% Parametrized command and environment for included LilyPond fragment
\newkeycommand{\lily}[%
    staffsize=\staffsize%
    ,staffsize=\directlua{ get_option('staffsize') }%
    ,line-width=\lilywidth%
    ,program=\directlua{ get_option('lilypondcmd') }%
    ][other-options][1]{%
\directlua{
    set_local_options({
        ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
        ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
}
\def\localwidth{\commandkey{line-width}}%
\begin{compilerly}%
{#1}
\end{compilerly}%
\directlua{reset_local_options()}%
}

\newkeyenvironment{ly}[%
    staffsize=\staffsize%
    ,staffsize=\directlua{ get_option('staffsize') }%
    ,line-width=\lilywidth%
    ,program=\directlua{ get_option('lilypondcmd') }%
    ][other-options]{%
\directlua{
    set_local_options({
        ['lilypondcmd'] = '\luatexluaescapestring{\commandkey{program}}',
        ['staffsize'] = '\luatexluaescapestring{\commandkey{staffsize}}'
    })
}
\def\localwidth{\commandkey{line-width}}%
\compilerly%
}{%
\endcompilerly%
\directlua{reset_local_options()}%
}

% Commands for compatibility with lilypond-book
\let\lilypondfile\includely
\protected\def\lilypond{\def\reserved@a{lilypond}%
  \ifx\reserved@a\@currenvir \expandafter \ly
  \else \expandafter\lily \fi}
\let\endlilypond\endly
